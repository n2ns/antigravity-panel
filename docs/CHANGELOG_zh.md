[English](../CHANGELOG.md) | 中文文档

# 更新日志

## [2.5.9] - 2026-01-19

### 修复

- **WSL2 镜像网络模式连接**: 修复了 WSL2 镜像网络 (Mirrored Mode) 下高达 50 秒的连接延迟。现在会过滤掉 DNS 解析地址 (`10.255.255.254`)，避免将其误认为 Host IP 进行探测。

### 改进

- **连接效率优化**: 通过追踪已验证的 PID 优化了语言服务器探测流程，避免在不同的探测路径下对同一进程进行重复的连接尝试。
- **启动稳定性**: 将初始连接延迟增加至 30 秒，以更好地兼容语言服务器较慢的初始化过程（通常由外部 Unleash 服务超时引起）。
- **调试日志**: 将 `tfa.system.debugMode` 默认值改为启用，以便更好地诊断和排查问题。
- **连接诊断增强**: 当配额刷新因服务器信息缺失而失败时，现在会在 Output Channel 输出警告日志，并附带操作指引（"尝试重启 IDE 或运行诊断工具"），帮助用户诊断静默刷新失败的问题。

## [2.5.8] - 2026-01-16

### 修复

- **图表数据泄漏**: 修复了用量历史图表 (Usage History) 错误包含已禁用次要模型（如 GPT）数据的问题。现在当 `tfa.dashboard.includeSecondaryModels` 设为 false 时，图表将严格过滤掉 GPT 的红色柱条。
- **图表缩放优化**: 改进了柱状图的 Y 轴缩放逻辑。现在缩放上限被限制在 25%，确保低用量（5-15%）的柱条依然清晰可见，不会被历史高峰数据“压扁”。此外，柱条顶部现在预留了 6px 的视觉空间，避免顶格显示。
- **活跃模型检测**: 修复了活跃模型检测逻辑中的缺陷，防止已禁用的模型（如 GPT）因配额消耗率较高而被错误识别为当前“活跃”模型。

## [2.5.7] - 2026-01-16

### 新增

- **调试配额日志**: 当启用 `tfa.system.debugMode` 时，每次刷新配额数据都会输出到 Output Channel。包含用户信息、Credits 和模型配额状态，并显示原始模型 ID 以便调试。
- **配额解析错误日志**: 当 JSON 解析失败或响应结构无效时，原始响应数据会被记录到日志中，帮助诊断 API 变更。

### 更改

- **刷新频率最小值**: 将 `tfa.dashboard.refreshRate` 的最小值从 60 秒降低到 30 秒，支持更快的配额更新响应。

## [2.5.6] - 2026-01-13
### 修复
- **Windows PowerShell 引号转义**: 修复了 `cmd.exe` 在启动 PowerShell 时剥离双引号的问题，采用单引号拼接 (`'name=''' + $n + ''''`) 替代插值字符串，解决了 Windows 系统上的 "ParserError" 解析错误。
- **Windows 工作区 ID 规范化**: 修复了扩展与语言服务器之间的工作区 ID 不匹配问题。新逻辑会对路径段进行 URL 编码，并将所有特殊字符（包括 `.`、`-`、空格）转换为下划线。例如 `israel.toledo` 和 `Local Projects` 现在能正确匹配服务器格式 (`israel_toledo`, `Local_20Projects`)。
- **UI 对比度**: 修复了浅色主题下 "Local service not detected" 提示信息中链接颜色不可读的问题，修正为继承按钮文本颜色。
- **进程检测超时**: 增加了 PowerShell 命令的超时时间（执行 3s→8s，预热 5s→10s），以适应 Windows 上的冷启动和 WMI 查询延迟。
- 特别感谢 @iskisraell 的贡献 (PR #47)。

## [2.5.5] - 2026-01-12
### 修复
- **浅色主题支持**: 修复了侧边栏面板在 VS Code 浅色主题下文字不可见或对比度不足的问题。使用原生 VS Code 主题变量（`--vscode-button-*`、`--vscode-button-secondary*`）替换了硬编码颜色。
- **代码清理**: 移除了未使用的 `.discussions-btn` CSS 类（约 36 行废弃代码）。

## [2.5.4] - 2026-01-12
### 修复
- **Windows 进程检测**: 修复了 PowerShell 引号转义问题 (Issue #46)，通过实施稳健的混合策略（插值字符串 + 格式化操作符回退）解决了部分 Windows 环境下的 "ParserError" 解析错误。

## [2.5.3] - 2026-01-12
### Fixed
- **Windows 进程检测**: 增加了 `wmic` 作为强力回退方案，解决了 PowerShell CIM 在部分受限环境下失效的问题。同时加强了解析安全性，新增 `--app_data_dir` 严格校验逻辑。
- **工作区 ID 匹配修复**: 修复了 Windows 路径规范化逻辑，现在能正确保留路径中的点号 (`.`) 和连字符 (`-`)。新增了松散匹配 (Loose Matching) 逻辑以提升连接稳定性。
- **文档与测试**: 更新了 `normalizeWindowsPath` 的技术文档说明，并新增了回归测试用例以确保复杂路径下的长期稳定性。

## [2.5.2] - 2026-01-11
### Improved
- **连接诊断**: 优化了"未检测到本地服务"的错误提示，增加了具体的失败原因（如"工作区不匹配"、"认证失败"）和"运行诊断工具"按钮。
- **故障排查**: 新增 `tfa.showLogs` 命令，方便快速查看扩展运行日志。

### Fixed
- **进程检测**: 修复了工作区 ID 匹配逻辑，正确处理了大小写、URL 编码和 UNC 路径问题，解决了"Wrong workspace detected"错误。
- **多语言修复**: 修复了新命令在部分语言下缺少翻译的问题。
- 特别感谢 @simbaTmotsi 的贡献 (PR #44)。

## [2.5.1] - 2026-01-11

### 新增
- **UI 缩放支持**: 新增 `tfa.dashboard.uiScale` 设置项，允许用户在 `0.8` 到 `2.0` 之间调整侧边栏面板的全局缩放比例。
- **等比例仪表盘**: 重构了圆环和半圆弧仪表盘，使用 `rem` 单位确保其能随全局 UI 缩放比例同步放大或缩小。
- **自动化质量护航**: 
  - 新增 NLS 对齐测试，确保 13 种语言包的键值对 1:1 完美映射。
  - 新增 `package.json` 占位符自动化校验，防止翻译遗漏。
  - 为 UI 缩放的边界值修正及数据分发逻辑添加了单元测试。

### 改进
- **本地化全面审计**: 对全部 13 个语言包进行了深度审计，同步了 `package.nls.json` 和 `bundle.l10n.json`，确保翻译完成度达到 100%。
- **服务恢复 UI**: 优化了文档说明并精细化了重启、重置和窗口重载工具，提升了系统稳定性。
- **服务稳定性**: 将 UI 相关的配置管理集成到 ViewModel 中，确保状态分发的一致性。

### 更改
- **代码清理**: 从 `shared.ts` 中移除了约 320 行废弃的 CSS 代码，并将 `webview.css` 拆分为多个组件化模块（`gauge.css`、`chart.css` 等），提升可维护性。

## [2.5.0] - 2026-01-11

### 新增
- **AI 提交信息生成器**: 新增了一个灵活的提交信息生成器，同时支持 **本地 LLM (Ollama)** 和 **Anthropic Claude**。
  - **双模式**: 开箱即支持本地 Ollama（隐私优先），同时也支持连接 Claude API 进行云端生成。
  - **替代方案**: 当 IDE 内置生成器不可用时，可作为强力替代。
  - **功能**: 支持 Conventional Commits 规范、自定义提示词以及智能 Diff 截断。
  - 特别感谢 @simbaTmotsi 的贡献 (PR #42)。

### 改进
- **进程检测**: 完全集成了增强的服务检测逻辑 (v2.4.7)。
- **UI 对比度**: 通过标准化前景色优化了面板内的文字可视性。

## [2.4.7] - 2026-01-10
### 修复
- **Windows 工作区 ID 不匹配**: 修复了因路径规范化差异导致 Windows 上语言服务器检测失败的问题。扩展现在正确地将驱动器号冒号编码为 `_3A_` 并保留目录大小写，以匹配语言服务器格式。
- **错误报告清晰度**: 新增 `workspace_mismatch` 失败原因，当所有候选进程因工作区 ID 不匹配被拒绝时提供更清晰的诊断信息。

### 更改
- **模块重构**: 将工作区 ID 规范化逻辑提取到 `shared/utils/workspace_id.ts`，提高可维护性和可测试性。

## [2.4.6] - 2026-01-08
### 修复
- **macOS 端口检测**: 改进 `lsof` 命令，添加 `-a` 标志和 PID grep 过滤，确保只捕获目标进程的端口。
- **PowerShell 冷启动**: 为 Windows 首次超时添加预热处理——等待 3 秒后重试，不消耗重试次数。
- **Linux 端口检测**: 添加动态命令检测（lsof > ss > netstat），避免特定命令不可用时出错。

### 新增
- **外部启动重试**: 在扩展层面添加 3 次额外重试，间隔 5 秒，在 ProcessFinder 内部重试之上提供额外的弹性机制。
- **诊断输出**: 检测失败时输出相关进程和平台特定的故障排除提示，帮助用户调试连接问题。

## [2.4.4] - 2026-01-05
### 修复
- **WSL 多配置文件支持**: 修复了在 WSL 环境中使用多个 VS Code 配置文件时显示不准确配额数据的问题。

### 新增
- **增强诊断**: 通过在"Toolkit for Antigravity"输出通道输出重试次数和详细失败原因（认证、网络、进程）改进连接故障排除。

## [2.4.3] - 2026-01-05
### 修复
- **关键修复**: 通过将健康检查端点更新为 `GetUserStatus` 修复了 `no_port` / 404 错误。
- **WSL 连接**: 通过探测 Windows 主机 IP 修复 NAT 模式问题。
- **网络**: 通过强制直连（`agent: false`）修复全局代理不稳定问题。
- **启动稳定性**: 添加 3 秒初始预热延迟，将重试次数增加到 5 次（总等待约 20.5 秒），解决较慢 Windows 环境的超时问题。
- **进程检测**: 添加基于关键字的健壮检测（`csrf_token`）回退机制。

### 新增
- 自动构建同步到 Windows 工件目录。

## [2.4.2] - 2026-01-01

### 修复
- **macOS 端口检测 (Issue #21)**: 修复 `parseListeningPorts` 函数错误包含其他进程端口的问题。现在会按 PID 过滤 `lsof` 输出，确保只检测目标 Language Server 的端口。

### 新增
- **增强诊断信息**: 自动上报的问题现在包含更多调试信息：
  - Token 预览（CSRF Token 前 8 个字符）
  - 端口来源（命令行参数 vs netstat）
  - 使用的协议（HTTPS 或 HTTP fallback）
  - 重试次数

## [2.4.1] - 2025-12-27
### 新增
- **自动接受间隔配置**: 新增 `tfa.system.autoAcceptInterval` 设置项，允许自定义自动接受功能的轮询频率（默认：800ms）。
- **完善多语言支持**: 为自动接受功能、命令及 Tooltip 补齐了全部 13 种支持语言的专业翻译。
- **UI 标签策略调整**: 为了保持技术术语的一致性，将所有面板标签和命令名称统一回退为英文，对应的悬浮提示（Tooltip）则保留完整的本地化翻译。

## [2.4.0] - 2025-12-27
### 更改
- **Tooltip 系统重构**: 使用全局管理器彻底重写了悬浮提示系统。提示框现在相对于视口采用 `position: fixed` 布局，确保在窄边栏中能够全宽显示，解决了被裁剪或溢出的问题。
- **页脚 UI 更新**: 更新了侧边栏页脚的“反馈”和“点赞”按钮，采用 VS Code 原生次级按钮样式，使界面更具专业感且与整体风格统一。

### 修复
- **侧边栏标题及翻译文本**: 修复了由于 `package.nls.json` 语法错误导致侧边栏标题及部分按钮文本显示为 `%key%` 的问题。
- **自动接受默认状态**: 明确了自动接受功能默认为“关闭”状态，且仅在用户手动开启后生效。

## [2.3.0] - 2025-12-25

### 新增
- **用户信息提取**: 从 Antigravity API 提取用户订阅信息（等级、套餐名称、升级选项）。
- **Token 用量追踪**: 新增 Prompt Credits 和 Flow Credits 用量追踪，支持格式化显示。
- **TokenUsageViewState**: 新增视图状态类型，用于在面板中展示 Token/积分消耗信息。
- **用户信息卡片开关**: 新增设置 `tfa.dashboard.showUserInfoCard`，可显示/隐藏用户资料卡片和积分条。
- **Tokens 区块标题**: 在侧边栏为 Prompt/Flow 积分新增独立的 "Tokens" 区块标题。
- **完整国际化支持**: 完成土耳其语 (`tr`) 和波兰语 (`pl`) 语言包的翻译。

### 更改
- **状态栏 Emoji 指示器**: 使用表情符号（🟢🟡🔴）替代背景颜色警告，界面更简洁。
- **移除仪表盘图标**: 从状态栏文本中移除 `$(dashboard)` 图标，因为 Emoji 指示器已提供视觉反馈。
- **Markdown 悬浮提示**: 状态栏悬浮提示现使用 MarkdownString 表格格式，实现完美列对齐。
- **缓存图标更新**: 将缓存图标从 💾 更改为 💿（光盘），视觉表达更清晰。
- **默认轮询间隔调整**: 将配额刷新间隔从 120 秒调整为 90 秒，响应更及时。
- **移除工具栏按钮提示**: 移除 Rules、MCP、Allowlist 按钮的 tooltip（开发者常识，无需额外提示）。

### 改进
- **PromptCreditsInfo 增强**: 新增 `usedPercentage` 字段，提供更全面的积分追踪。
- **FlowCreditsInfo**: 新增接口用于追踪 Flow Credits（用于复杂 AI 操作）。
- **工具栏按钮布局优化**: 修复窄侧边栏下按钮文字被挤压的问题，使用弹性基准宽度和 `white-space: nowrap`。
- **用量图表图例换行**: 改进 Timeline/Step 和预测信息的自适应换行逻辑。
- **积分条间距优化**: 增加 16px 顶部边距，使 Tokens 区块与用量历史图表拉开距离。
- **区块标题主题化**: 为 Brain 和 Code Tracker 标题应用 VS Code 次级按钮主题色。
- **Tooltip 溢出修复**: 实现右侧边缘智能对齐，防止提示框被侧边栏边界裁剪。

## [2.2.2] - 2025-12-20

### 更改
- **缓存设置重组**: 将缓存相关设置（`autoClean`、`autoCleanKeepCount`、`scanInterval`、`warningSize`、`hideEmptyFolders`）从"系统与维护"移至独立的"TFA: 缓存"配置组，便于用户发现和管理。
- **配置命名空间更新**: 将缓存设置从 `tfa.system.*` 重命名为 `tfa.cache.*` 命名空间，语义更清晰。
- **自动清理通知优化**: 改进通知消息，显示清理前后的缓存大小（如"自动清理完成。清理前：512 MB，清理后：245 MB"）。
- **缓存警告按钮调整**: 将"前往设置清理"按钮替换为"查看"（打开 brain 目录）和"设置"（打开扩展设置），操作更直观。
- **警告冷却时间**: 将缓存警告通知冷却时间从 24 小时缩短至 1 小时，提供更及时的提醒。

### 修复
- **重复通知修复**: 修复了同一扫描周期内可能同时弹出自动清理通知和手动警告通知的问题。
- **多语言完整性**: 更新了全部 10 种语言的翻译文件，补充了缓存通知相关的新字符串。

## [2.2.1] - 2025-12-18

### 更改
- **调整配置选项**: 全局将 `gagp` 前缀更名为 `tfa`，并将所有设置项按功能重组为逻辑索引组（看板、状态栏、系统）。
- **仪表盘布局优化**: 细化了仪表盘与文字标签之间的间距，使整体排版更加紧凑、比例更平衡。

### 新增
- **服务恢复工具**: 在侧边栏新增了专属的“重启服务”和“重置状态”按钮，用于快速排查 Agent 无响应及配额同步问题。
- **连接检测诊断**: 新增 `tfa.runDiagnostics` 命令用于手动验证服务器状态；诊断详情（PID、端口、尝试结果）会直接输出到主日志通道 "Toolkit for Antigravity"，方便在不丢失上下文的情况下进行故障排查。

### 修复
- **状态栏显示**: 修复了 `resetTime` 无法更新以及 `used`/`remaining` 始终显示百分比的问题。现在它们能正确显示重置时间（如 "2h 30m"）和分数组合（如 "25/100"）[修复 #9]。
- **多语言加载**: 修复了 v2.2.0 中因打包配置问题导致的自动反馈报告中丢失本地化文本（如 `report.*`）的问题 [修复 #5, #8]。
- **测试覆盖**: 新增了自动化测试，确保多语言完整性和状态栏格式的正确性。

## [2.2.0] - 2025-12-18

### 新增
- **模块化仪表盘架构**: 重构了配额可视化系统，采用基于策略的模块化架构，支持多种显示样式。
- **精工业半圆仪表盘**: 实现全新的 210 度“工业级精度”仪表样式，具备多轨道布局及主题自适应配色（已设为默认）。
- **视觉自定义**: 新增 `tfa.quotaDisplayStyle` 设置项，允许用户在“半圆弧”与“经典圆环”样式间自由切换。
- **响应式页脚**: 优化了侧边栏页脚在极端窄宽度下的表现，支持按钮自动换行及布局自适应。

### 改进
- **类型安全升级**: 消除了核心 Webview 组件中的 `any` 类型使用，提升系统稳定性。
- **数学精度优化**: 将 SVG 几何计算提取至独立工具库，并配备了专门的逻辑单元测试。

### 修复
- **侧边栏布局溢出**: 解决了在侧边栏宽度极窄时，底部的控制按钮被截断的问题。

## [2.1.0] - 2025-12-17

### 新增
- **智能反馈 system**: 引入支持多语言的 Bug 报告系统，自动预填充非敏感诊断信息（版本、OS、错误码、进程数）。
- **增强型检测诊断**: `ProcessFinder` 现在能精确识别失败原因：未找到进程、多实例歧义、无端口映射及认证故障。
- **解析异常监控**: 实时监控服务器 API 响应格式，并在解析出错时提供一键反馈入口。
- **国际化框架**: 在逻辑代码层通过 `vscode.l10n` 实现了弹窗消息的 100% 国际化对齐。
- **模型配额细化**: 在状态栏和侧边栏中将 Gemini 3 Flash 从 Gemini Pro 中分离，支持独立追踪。
- **状态栏精简显示**: 使用简短标签（如 "Pro", "Flash"）显示活跃组配额，并增强 Hover 提示以显示所有活跃组的详细信息。
- **社区化集成**: 在侧边栏页脚加入“加入讨论”入口，打通用户反馈与 GitHub Discussions。
- **质量护航**: 引入 Husky 与 lint-staged，在提交前强制执行 ESLint 检查及全量单元测试。

### 改进
- **UI 标题对齐**: 修复侧边栏标题冗余问题（如“工具箱: Toolkit”），现在统一显示为 `Antigravity: 工具箱`。
- **MVVM 架构深化**: 将反馈与诊断逻辑解耦至独立的 `FeedbackManager` 组件，保持 View 层洁净。
- **仪表盘排序控制**: 强制模型饼图按照本地策略配置顺序排列（Gemini Flash 优先显示）。

### 修复
- **UI 显示零点死区**: 解决配额重置时间显示为 "Ready" 时，饼图未及时归位 100% 的同步问题。
- **技术债务清理**: 彻底修复并清零了 ESLint 报告的所有 11+ 项错误与警告。

## [2.0.0] - 2025-12-17

### 改进
- **架构优化**: 重构 `ConfigManager` 和 `WebviewHtmlBuilder` 以提升可测试性
  - 引入 `IConfigReader` 接口实现依赖注入
  - 移除核心模块对 `vscode` 模块的直接依赖
  - 核心业务逻辑现可在纯 Node.js 环境中进行单元测试
- **依赖注入**: `SidebarProvider` 现通过构造函数接收依赖，而非内部创建实例
- **CSP 安全优化**: 提取内联样式到外部 CSS 文件，移除 `'unsafe-inline'`

### 新增
- **新增单元测试**: 为 `ConfigManager` 和 `WebviewHtmlBuilder` 添加全面测试
  - `config_manager.test.ts`: 18 个新测试
  - `html_builder.test.ts`: 13 个新测试
  - 15 个测试文件，152 个测试用例通过

## [1.1.0] - 2025-12-11

### 新增
- **独立缓存轮询**: 缓存大小检查现独立运行，可配置间隔（`gagp.cacheCheckInterval`）
- **缓存警告通知**: 缓存超过阈值时自动警告，24 小时冷却防止刷屏
- **隐藏空文件夹选项**: 新设置项（`gagp.cacheHideEmptyFolders`）可隐藏 Brain 和 Code Tracker 树中的空文件夹

### 改进
- **智能缓存清理**: 保留最新 5 个 brain 任务及其对话，避免中断正在进行的工作
- **清理缓存对话框**: 添加"打开文件夹"按钮用于手动清理
- **删除确认**: Code Tracker 目录删除现显示确认对话框

### 修复
- **Code Tracker 删除按钮**: 修复因 Lit 属性反射问题导致删除按钮不工作的问题
- **删除后树刷新**: 修复文件/文件夹删除后目录树不刷新的问题

## [1.0.3] - 2025-12-10

### 新增
- **MVVM 架构**: 引入 QuotaViewModel 作为统一数据聚合层
- **活跃分组自动检测**: 基于配额消耗变化（>0.1% 阈值）自动检测活跃模型分组
- **缓存优先启动**: UI 立即从缓存渲染，然后异步刷新

### 修复
- **状态栏活跃分组**: 修复活跃分组显示错误（之前因简单字符串匹配导致显示错误分组）
- 修复扩展侧边栏和工具栏中的图标显示问题

## [1.0.2] - 2025-12-10

### 改进
- 扩展包体积减少 85%，加快安装和更新速度
- 提升扩展加载性能

## [1.0.1] - 2025-12-10

### 修复
- 修复配额预测显示在加载后消失的问题
- 修复启动时配额图表渲染问题

### 改进
- 增强代码质量和稳定性

## [1.0.0] - 2025-12-09

### 新增
- 首次发布
- 实时 Gemini API 配额监控，带可视化图表
- Gemini 对话缓存管理
- 快速访问 Gemini 配置文件
- 配额不足时颜色警告（警告/严重阈值）
- 独立追踪并显示 Gemini Pro 与 Gemini Flash 分组
- 可配置轮询间隔自动刷新（最小 60 秒）
- 状态栏集成，显示当前配额使用情况
